---
title: "odbc, DBI, and dbplyr"
output: html_notebook
---

Set up connection to `PTRAN`. This can take a little while to open the connection, in RStudio, you should see a list of tables you have access to in the right-top window when you have your connection. You can also skip this step if you have the connection setup in RStudio through their setup process.
```{r}
library(dbplyr)
library(tidyverse)
library(odbc)
library(DBI)

PTRAN <- DBI::dbConnect(odbc::odbc(),
                 dsn   = "PTRAN 64bit",
                 PWD    = rstudioapi::askForPassword("Database password"),
                 Port   = 1521)
```


Once that is complete, you need to pull in the table you're interested in using the `tbl` function (as `SABS_OSDINF` is associated with a particular schema, need to use the `in_schema` function to specify the schema and table). 

Once `OSDINF` is created, you can actually perform your query. `dblyr` allows you to use `dplyr` syntax to select, filter, and manipulate your data in (somewhat) familiar ways. `dbplyr` interprets `dplyr` syntax into simple SQL queries so you don't have to. 
```{R}
# Pull in deployment information from LOSIERR.SABS_OSDINF (because table was created under a specific person's schema, need to use in_schema)
  OSDINF <- tbl(PTRAN, in_schema("LOSIERR", "SABS_OSDINF"))

  OSDINF %>%
    select(DEPLOY, STATION, SDATE, LATITUDE, LONGITUDE) %>%
    filter(DEPLOY < 10)
```

Data is not downloaded from the oracle server **until** you use the function `collect()` allowing you to fine tune your queries without downloading data multiple times or grabbing a copy of the entire database to use.  
```{r}
OSDINF <- OSDINF %>%
    select(DEPLOY, STATION, SDATE, LATITUDE, LONGITUDE) %>%
    filter(DEPLOY < 10) %>%
  collect() %>% #creates a tibble
  data.frame()
OSDINF
```

Now that the you have downloaded your query and assigned it a variable name, you can use it just like any other data in R.
```{r}
summary(OSDINF)
```

